% !TeX spellcheck = en_GB
%\documentclass[handout]{beamer}\mode<presentation>{\usetheme{AMSCesenaPurpleAndGold}}
\documentclass[presentation]{beamer}\mode<presentation>{\usetheme{AMSCesenaPurpleAndGold}}
%%%%

\usepackage{sd-lab-building-agents}
\usepackage{my-listings}
\usepackage{forloop}

\newcommand{\labN}{4}
\newcommand{\labGroup}{https://gitlab.com/pika-lab/courses/ds/ay2021}
\newcommand{\labRepo}{\labGroup/lab-\labN}


\title[L\labN{} -- Building Agents]{Building Agents from Scratch}
%
\subtitle[SD]{Distributed Systems / Technologies}
%
\author[Ciatto \and Omicini]
{\emph{Giovanni Ciatto} \and Andrea Omicini\\
	\texttt{giovanni.ciatto@unibo.it \and andrea.omicini@unibo.it}}
%
\institute[DISI, Univ. Bologna]
{Dipartimento di Informatica -- Scienza e Ingegneria (DISI)\\\textsc{Alma Mater Studiorum} -- Universit{\`a} di Bologna a Cesena}
%
\date[A.Y. 2020/2021]{Academic Year 2020/2021}

\setbeamercovered{transparent}

\AtBeginSection{
	\begin{frame}[c]\frametitle{Outline}
		% 		\begin{multicols}{2}
		\tableofcontents[sectionstyle=show/shaded, subsectionstyle=hide/hide, subsubsectionstyle=hide/hide]
		% 		\end{multicols}
	\end{frame}
}

\AtBeginSubsection{
	\begin{frame}[c]\frametitle{Next in Line\ldots}
		\begin{multicols}{2}
			\tableofcontents[sectionstyle=show/shaded, subsectionstyle=show/shaded, subsubsectionstyle=hide/hide]
		\end{multicols}
	\end{frame}
}

\begin{document}

%\\\\\\\\\\\\\\\\\\\\\
\frame{\titlepage}
%\\\\\\\\\\\\\\\\\\\\\

\section{Motivation \& Lecture Goals}

\begin{frame}[allowframebreaks]
\frametitle{Motivation \& Lecture Goals}

	\begin{itemize}
		\item This lecture is aimed at showing how \jade{}-like agents can be constructed from scratch
		%
		\begin{itemize}
			\item we will build a simple framework for MAS execution $\ldots$
			\item $\ldots$ to be extended in future lectures with interaction- and distribution-related features
		\end{itemize}
		
		\bigskip
		
		\item Building an agent framework requires defining, at least:
		%
		\begin{enumerate}
			\item how agents are executed, created, stopped, or paused (and therefore resumed)
			\item how agents may carry on several \emph{behaviours}, concurrently
			\item how agents may \emph{interact}, possibly in spite of distribution
		\end{enumerate}
	\end{itemize}

\end{frame}

\subsection{About the practical activities}

\begin{frame}
\frametitle{Lab \labN{} Repository on GitLab}

	\begin{itemize}
		\item Examples and exercises described in this lecture are provided by means of the following GitLab repository:
		%
		\begin{center}
			\url{\labRepo}
		\end{center}
		
		\vfill
		
		\item Clone it on your machine using Git
		%
		\begin{itemize}
		    \item[\$] \texttt{git clone \textit{<repo URL>}}
		\end{itemize}
		
		\vfill
		
		\item Even if a minimal environment simply relying on a text editor + Gradle is sufficient for this lab, we kindly suggest to import the cloned repository into some IDE, e.g. IntelliJ Idea or Eclipse
		%
		%
		\begin{itemize}
		    \item in case of problems in importing the project on IntelliJ, try to downgrade the gradle wrapper
		\end{itemize}
		
		\vfill
		
		\item In order to be able to submit your exercises, please ensure you requested access to the \href{\labGroup}{GitLab group of the course}
	\end{itemize}

\end{frame}

\section{Towards Multi-Agent Systems}

\subsection{Metamodel}

\begin{frame}[allowframebreaks]
\frametitle{Metamodel}

	\begin{block}{MAS}
	    We consider a MAS to be composed by a number of agents \alert{interacting} within an environment
	\end{block}

	\bigskip
	
	\begin{block}{Environment}
		We consider an Environment as a container of agents, exposing \emph{shared} facilities aimed at \alert{supporting} the agents' \alert{creation}, and \alert{interaction}
	\end{block}
	
	\bigskip
	
	\begin{block}{Agent}
	    We consider an Agent as a \alert{named} object (data + behaviour) coming with its own \alert{internal scheduler} aimed at executing an arbitrary amount of \alert{behaviours} concurrently
	\end{block}
	
	\bigskip
	
	\begin{block}{Agents' Finite State Machine (FSM)}
		We assume each Agent is moved by an internal FSM aimed supporting life-cycle management operations such as: \emph{start}, \emph{restart}, \emph{pause}, \emph{resume}, \emph{stop}	
	\end{block}

	\bigskip
	
	\begin{block}{Agent Identifier (AID)}
		We assume each Agent is uniquely identified by an AID:
		%
		\begin{center}
			AID = agent name + environment name
		\end{center}
	\end{block}
	
	\bigskip
	
	\begin{block}{Behaviours}
		We consider a Behaviour as an atomic or composite action an agent may carry on, concurrently (w.r.t. other Behaviours)
	\end{block}
	
	\bigskip
	
	\begin{block}{Agents' Interaction}
		Any means letting an agent affect the operation of other agents.
		Can be achieved in several ways (message-passing, shared-memory, stigmergy, etc).
		%
		\begin{center}\bfseries
			(we will endow agents with interaction in future lectures, via \linda{})
		\end{center}
	\end{block}

\end{frame}

\subsection{Activity Overview}

\begin{frame}%[allowframebreaks]
	\frametitle{Activity Overview}
	
	For each notion in the aforementioned meta-model, we will:
	%
	\vfill
	%
	\begin{enumerate}
		\item draw the general design
		
		\vfill
		
		\item propose a minimal Java interface
		
		\vfill
		
		\item sketch the architecture
		
		\vfill
		
		\item describe the implementation stub
		
		\vfill
		
		\item complete the implementation via exercises
	\end{enumerate}
	
\end{frame}

\subsection{Agent Identifiers}

\begin{frame}{\texttt{AID} Class}
	
	\lstinputlisting{code/AID.java}
	
\end{frame}

\begin{frame}{\texttt{AID} Class -- Design Rationale}
	
	\begin{itemize}
		
		\item In the general case, agents are identified by two names:
		%
		\begin{itemize}
			\item the agent's \alert{local} name
			\item the name of the environment hosting the agent
		\end{itemize}
	
		\vfill
		
		\item In some cases, the environment name maybe unknown, thus missing
		%
		\begin{itemize}
			\item in this case, we say the \texttt{AID} is \alert{local}
			\item otherwise, we say the \texttt{AID} is \alert{full}
		\end{itemize}
	
		\vfill
		
		\item Full \texttt{AID} can be created via the \texttt{AID.full} \alert{static} method
		
		\vfill
		
		\item Local \texttt{AID} can be created via the \texttt{AID.local} \alert{static} method
		
		\vfill
		
		\item The \texttt{AID.parse} \alert{static} method can be used to parse \texttt{AID} from well formed strings in the form: \texttt{"localName@environmentName"}
	\end{itemize}
	
\end{frame}

\subsection{Environment}

\begin{frame}[allowframebreaks]{Environment Interface}
    
    \lstinputlisting{code/Environment.java}
    
\end{frame}

\begin{frame}{\texttt{Environment} Interface -- Design Rationale}
    
    \begin{itemize}
    		
    	\item Given some subtype \texttt{A} of \texttt{AgentFSM}, an environment can only host agents whose type is \texttt{A}
    	%
    	\begin{itemize}
    		\item the actual type \texttt{A} is specified at instantiation time
    	\end{itemize}
    
	    \vfill
	    
	    \item Environments have their own unique name
    	
    	\vfill
    	
    	\item The set of \texttt{AID} currently hosted by the environment can be retrieved via the \alert{\texttt{getAgents}} method
    	
    	\vfill
        
        \item Via environments, agents' FSM can either
        %
        \begin{itemize}
            \item be created outside the environment and then join it via the \alert{\texttt{register}} method
            %
            \item be created as part of the environment, via the \alert{\texttt{create}} method
        \end{itemize}
    
    	\vfill
    	
    	\item Users can block until all agents terminated via the \alert{\texttt{awaitAllAgents}} method
        
    \end{itemize}
    
\end{frame}

\begin{frame}[allowframebreaks]{\texttt{Environment} Interface -- Implementations}
    
    \begin{block}{\texttt{sd.lab.agency.impl.\textit{AbstractEnvironment}}}
        Provides common facilities for agents' initialisation and registration, which can be reused by sub-classes
    \end{block}
    
    \bigskip
    
    \begin{exampleblock}{\texttt{sd.lab.agency.impl.\textit{MultiThreadedEnvironment}}}
        \begin{itemize}
			\item A particular sort of environment where each agent is executed on its own thread
			\item Instances of \texttt{MultiThreadedEnvironment} can be instantiated via the \alert{\texttt{Environment.multiThreaded}} static method
			\item This will be implemented and used in exercise \labN{}-1
        \end{itemize}
    \end{exampleblock}

	\bigskip

	\begin{exampleblock}{\texttt{sd.lab.agency.impl.\textit{ExecutorBasedEnvironment}}}
		\begin{itemize}
			\item A particular sort of environment where all agents are executed on the same executor service
			\item Instances of \texttt{ExecutorBasedEnvironment} can be instantiated via the \alert{\texttt{Environment.executorBased}} static method
			\item This will be implemented and used in exercise \labN{}-2 (which is \emph{optional})
		\end{itemize}
	\end{exampleblock}
    
    \bigskip
    
    \begin{alertblock}{(Spoiler Alert) \textbf{Distributed} Environment}
        \begin{itemize}
        	\item Supports the interaction among agents running on different machines
        	\item Will be designed and implemented in future lectures
        \end{itemize}
    \end{alertblock}
    
\end{frame}


\subsection{Agent FSM}

\begin{frame}[allowframebreaks]{\texttt{AgentFSM} Interface}
    
    \lstinputlisting{code/AgentFSM.java}
    
\end{frame}

\begin{frame}[allowframebreaks]{\texttt{AgentFSM} Interface -- Rationale}
    
    % \begin{block}{Agent VS User perspectives}
    %     The functioning of agents can be described and understood according to two different perspectives:
        
    % \end{block}
    
    Expected functioning of all objects of type \alert{\texttt{AgentFSM}}:
    %
    \bigskip
    %
    \begin{itemize}
        \item an FSM is created by some other entity as an ordinary Java object
        
        \bigskip
        
        \item it may be started from outside by means of the \texttt{\alert{start()}} method 
        
        \bigskip
        
        \item once started, the following things should happen:
        %
        \begin{enumerate}
            \item the \texttt{\alert{onBegin()}} callback is executed \alert{just once}
            
            \item \alert{after} that, the \texttt{\alert{onRun()}} method is executed an \alert{unlimited} amount of times, sequentially
    
            \item the sequence of executions of \texttt{onRun()} can only be interrupted by the agent itself by calling the \texttt{\alert{stop()}} method inside its \texttt{onBegin()} or \texttt{onRun()} callbacks
        \end{enumerate}
        
        \framebreak
        
        % \item if the agent calls its \texttt{Agent::\alert{pause()}} method, the sequence of \texttt{onRun()} is interrupted as well
        
        % \vspace{.5cm}
        
        % \item however, if some external entity calls the 
        % \texttt{Agent::\alert{resume()}} method on a paused agents, the sequence of \texttt{onRun()} is resumed \alert{from where it had been interrupted}
        
        % \vspace{.5cm}
        
        % \item if the agent calls its \texttt{Agent::\alert{restart()}} method, the sequence of \texttt{onRun()} is restarted---and the \texttt{onBegin()} method is executed one more time
        
        % \vspace{.5cm}
        
        % \item finally, external entities can wait for an agent's termination by means of the \texttt{Agent::\alert{await()}} method and its overloads
        
        % \framebreak
        
        % \item in any scenario, if some \alert{uncaught exception} is thrown within the \texttt{onBegin()} or \texttt{onRun()} methods, the \texttt{Agent::\alert{onUncaughtError(Exception)}} callback is called
        
        % \vspace{.5cm}
        
        % \item what happens next depends on the value returned by the \texttt{onUncaughtError(Exception)} callback, which is of type \alert{\texttt{AndThen}}
        % %
        % \begin{description}
        %     \item[\texttt{CONTINUE}] | the exception is ignored and the sequence of \texttt{onRun()} is unaffected
            
        %     \item[\texttt{PAUSE}] | the sequence of \texttt{onRun()} is paused
        % \end{description}
        
        \item after that, the agent \alert{terminates}---which means that all entities which possibly invoked the \texttt{\alert{await()}} method, can now resume their computation
        
        \bigskip
        
        \item within its \texttt{onBegin()}, \texttt{onRun()}, or \texttt{onEnd()} methods, an agent can call the following methods affecting its own control flow and, in particular, the sequence of \texttt{on*()} methods executions:
        %
        \begin{description}\small
            \item[\texttt{stop()}] states that the next method to be executed should be \texttt{onEnd()}
            
            \item[\texttt{restart()}] states that the next method to be executed should be \texttt{onBegin()}
            
            \item[\texttt{pause()}] states that no method should be executed next, until \texttt{resume()} is called
            
            \item[\texttt{resume()}] states that the sequence of \texttt{on*()} methods executions should be resumed starting from where it was interrupted by the \texttt{pause()}
        \end{description}
        
        \framebreak
        
        \item \alert{no uncaught exception} should be able to break the aforementioned workflow
        
        \bigskip
        
        \item to this end, \texttt{\alert{onUncaughtError(Exception)}} callback is executed for each exception which is not caught within the \texttt{onBegin()}, \texttt{onRun()}, or \texttt{onEnd()} methods
        
        \bigskip
        
        \item after the \texttt{onUncaughtError(Exception)} callback is executed, the aforementioned workflow continues as if the exception didn't occurred (i.e. the series of \texttt{onRun()} is resumed)
        %
        \begin{itemize}
            \item unless the agent calls some life-cycle control method within the \texttt{onUncaughtError(Exception)} callback
        \end{itemize}      
    \end{itemize}
\end{frame}

\begin{frame}{External VS internal API}

\begin{itemize}
    \item \texttt{AgentFSM} is actually the union of two API targetting different usages
    
    \vfill
    
    \item The \alert{external} API comprehends methods which are to be called \alert{from outside} the agent
    %
    \begin{itemize}
        \item[eg] method \texttt{\alert{start()}}
        \item[eg] method \texttt{\alert{await()}}
        \item[eg] method \texttt{\alert{resume()}}
    \end{itemize}
    
    \vfill
    
    \item The \alert{internal} API comprehends methods which are to be called \alert{from within} the agent itself
    %
    \begin{itemize}
        \item[eg] method \texttt{\alert{stop()}}
        \item[eg] method \texttt{\alert{pause()}}
        \item[eg] method \texttt{\alert{pause()}}
        \item[eg] method \texttt{\alert{restart()}}
    \end{itemize}
    
    \vfill
    
    \item Briefly speking, methods composing the \alert{internal} API can be called by agent implementors, \alert{only} within the \texttt{on*()} callbacks
    %
    \begin{itemize}
        \item calling them elsewhere may lead to unexpected \& unpredicatable behaviour
    \end{itemize}
\end{itemize}

\end{frame}

\subsubsection{Examples of valid scenarios}

\begin{frame}{Normal Flow}\centering
    \includegraphics[height=.8\textheight]{img/normal-flow.pdf}
\end{frame}

\begin{frame}{Pause and Resume}\centering
    \includegraphics[height=.8\textheight]{img/paused-flow.pdf}
\end{frame}

\begin{frame}{Restart}\centering
	\includegraphics[height=.8\textheight]{img/restarted-flow.pdf}
\end{frame}

\begin{frame}[allowframebreaks]{Uncaught Exceptions}
    \begin{center}
    	\includegraphics[height=.8\textheight]{img/exceptional-flow-1.pdf}
    \end{center}
    
    \begin{center}
    	\includegraphics[height=.8\textheight]{img/exceptional-flow-2.pdf}
    \end{center}
    
    \begin{center}
    	\includegraphics[height=.8\textheight]{img/exceptional-flow-3.pdf}
    \end{center}
\end{frame}

\subsubsection{Usage Example}

\begin{frame}[allowframebreaks]{Example}
    Setting up the environment:
    %
    \lstinputlisting{code/ExampleEnvironment.java}
    
    \framebreak
    
    The agent FSM:
    %
    \lstinputlisting{code/ExampleAgentFSM.java}
    
    Expected logs:
    %
    \begin{itemize}
    	\item[$\rightarrow$] 0, 1, 2, 3, 4, 5, 6
    \end{itemize}
\end{frame}

\begin{frame}[allowframebreaks]{Agent FSM state diagram}

    \begin{itemize}
        \item The agents' functioning just described can be modelled through a state diagram
        
        \bigskip
        
        \item In any given moment, the FSM may be in any of $5+1$ states:
        %
        \begin{description}
            \item[\texttt{CREATED}] | the agent has been instantiated but not yet started
            
            \item[\texttt{STARTED}] | after the \texttt{start()} method has been called
            
            \item[\texttt{RUNNING}] | after the \texttt{onBegin()} callback has been executed
            
            \item[\texttt{PAUSED}] | after the \texttt{pause()} method has been called
            
            \item[\texttt{STOPPED}] | after the \texttt{stop()} method has been called
            
            \item[terminated] | after the \texttt{onStop()} callback has been executed
        \end{description}
    
    	\bigskip
    	
    	\item Such states are represented by the \texttt{sd.lab.agency.fsm.impl.\alert{State}} enum
        
        \framebreak
        
        \item State transition are usually provoked by invocations of the \alert{control methods}
        %
        \begin{itemize}
        	\item i.e., the \texttt{start()}, \texttt{stop()}, \texttt{restart()}, \texttt{pause()}, or \texttt{resume()} methods
        \end{itemize}
    
    	\bigskip
        
        \item Such methods feed the FSM with values of type \texttt{sd.lab.agency.fsm.impl.\alert{Operation}}
        %
        \begin{itemize}
        	\item i.e., \texttt{CONTINUE}, \texttt{RESTART}, \texttt{PAUSE}, or \texttt{STOP} 
        	\item if no control method is called within a callback, \texttt{\alert{CONTINUE}} is fed to the FSM, by default
        \end{itemize}
        
        \bigskip
        
        \item State transition of the FSM provoke the invocation of callbacks
         %
        \begin{itemize}
        	\item i.e., \texttt{onBegin()}, \texttt{onRun()}, \texttt{onEnd()}, or \texttt{onUncaughtException(...)}
        \end{itemize}
    \end{itemize}
    
    \framebreak
    
    \begin{center}
        \includegraphics[height=.9\textheight]{img/fsa.pdf}
    \end{center}
    
\end{frame}

\section{Exercises}

\subsection{Implementing the FSA}

\begin{frame}[allowframebreaks]{Exercise 5-1 -- Implementing \texttt{BaseAgent}}
    Consider the \texttt{sd.lab.agency.impl.\alert{BaseAgent}} class:
    %
    \lstinputlisting{code/BaseAgent.java}
    
    \framebreak
    
    \begin{block}{TODO}
        Complete the implementation of the following methods:
        %
        \begin{itemize}
            \item \texttt{BaseAgent::\alert{doStateTransitionFrom\textit{Created}}}
            
            \item \texttt{BaseAgent::\alert{doStateTransitionFrom\textit{Started}}}
            
            \item \texttt{BaseAgent::\alert{doStateTransitionFrom\textit{Running}}}
            
            \item \texttt{BaseAgent::\alert{doStateTransitionFrom\textit{Paused}}}
            
            \item \texttt{BaseAgent::\alert{doStateTransitionFrom\textit{Stopped}}} 
            
            \item \texttt{BaseAgent::\alert{doBegin}}, and  \texttt{BaseAgent::\alert{begin}}
            
            \item \texttt{BaseAgent::\alert{doRun}}, and \texttt{BaseAgent::\alert{run}}
            
            \item \texttt{BaseAgent::\alert{doEnd}}, and \texttt{BaseAgent::\alert{end}}
        \end{itemize}
        %
        in such a way that all tests in \texttt{sd.lab.agency.\alert{TestAgent}} are satisfied
    \end{block}
\end{frame}

\subsection{A simple ping-ping system}

\begin{frame}[allowframebreaks]{Exercise 5-2 -- Implementing ping-pong}

\begin{block}{TODO}
    \begin{itemize}
        \item Complete the implementation of \texttt{\alert{PongAgent}}
        
        \item In such a way that all tests in \texttt{sd.lab.agency.\alert{TestPingPong}} are satisfied
    \end{itemize}
\end{block}

\begin{exampleblock}{Specification}
    \begin{itemize}
        \item The Pong agent waits for a message whose content is \texttt{"ping"} coming from the Ping agent
        
        \item It then then responds back with a message whose content is \texttt{"pong"}, directed towards the Ping agent
        
        \item Such behaviour is repeated until the Pong agent receives a containing \texttt{"stop"}
        
        \item[!] You can assume each agent knows the name of the other one, by construction
    \end{itemize}
\end{exampleblock}

\begin{alertblock}{Question time}
    \begin{itemize}
        \item Can you see why suspensive operations are non-blocking in our architecture?
        
        \item Can you see where our architecture falls short?
    \end{itemize}
\end{alertblock}

\end{frame}

\subsection{White pages prototype}

\begin{frame}[allowframebreaks]{Exercise 5-3 -- Dynamically searching agent names}

\begin{itemize}
    \item In the Ping-pong example, agents are aware of their respective names, \alert{by construction}
    
    \vspace{.3cm}
    
    \item This is ok for examples, but \alert{it is not the case} in real world Distributed Systems
    
    \vspace{.3cm}
    
    \item There, a \alert{white pages} service is usually in place, letting \alert{discover} their peers, \alert{dynamically} 
    
\end{itemize}

\vspace{.3cm}

\begin{block}{TODO}
    Try editing the Ping \& Pong agents in such a way that they are able to \alert{discover} each others dynamically, \alert{before} starting the ping-pong protocol
\end{block}

\framebreak

\begin{exampleblock}{Some advices}
    \begin{itemize}
        \item What about employing a \alert{tuple space} as white pages?
        
        \item Consider exploiting ``Negative Lookaheads'' in regular expressions
        %
        \begin{itemize}
            \item[ie] \url{https://www.regular-expressions.info/lookaround.html}
            \item[eg] \url{https://regex101.com/r/66NTyD/1}
            \item[eg] class \texttt{sd.lab.linda.textual.\alert{TestNegatedTemplate}}
        \end{itemize}
    \end{itemize}
\end{exampleblock}

\end{frame}

%===============================================================================
\section*{}
%===============================================================================

%\\\\\\\\\\\\\\\\\\\\\
\frame{\titlepage}
%\\\\\\\\\\\\\\\\\\\\\

%%===============================================================================
%\section*{\refname}
%%===============================================================================
%
%%\\\\\\\\\\\\\\\\\\\\\
%%%%%
%%\begin{frame}[t,allowframebreaks]\scriptsize
%\begin{frame}[c]\footnotesize
%\frametitle{\refname}
%\bibliographystyle{apalike}
%\bibliography{sd-lab-building-linda}
%\end{frame}
%%\\\\\\\\\\\\\\\\\\\\\

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{document}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

